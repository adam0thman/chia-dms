<h2 class="text-info">Manage Sessions <small class="text-muted">For <holder id="txt-org-name"></holder></small></h2>
<hr class="mb-12">

<hr class="mb-6">
    
    <form class="form-inline">
      <div class="form-group mb-2">
        <label for="input-month">Select Month </label>
        <select class="form-control mx-sm-3" id="input-month">
          <option value="0">January</option>
          <option value="1">February</option>
          <option value="2">March</option>
          <option value="3">April</option>
          <option value="4">May</option>
          <option value="5">June</option>
          <option value="6">July</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">October</option>
          <option value="10">November</option>
          <option value="11">Disember</option>
        </select>
      </div>
      <div class="form-group mb-2">
        <label for="input-year">Select Year </label>
        <select class="form-control mx-sm-3" id="input-year">
          <option value="2018">2018</option>
          <option value="2019">2019</option>
          <option value="2020">2020</option>
          <option value="2021">2021</option>
          <option value="2022">2022</option>
        </select>
      </div>
      <div class="form-group mb-2">
        <a href="#" class="btn btn-outline-info" id="btn-show-session">Show Sessions</a>
      </div>
    </form>

<hr class="mb-4" >
<h5><holder id="txt-org-name-table"></holder> Sessions for <holder id="txt-month-year-table"></holder>.</h5>
<form class="form-inline">
  <div class="form-group mb-2">
    <label for="staticfilter" class="sr-only">Search </label>
    <input id="staticfilter"  type="search" class="form-control-plaintext light-table-filter" data-table="order-table" placeholder="Search keyword here..">
  </div>
</form>
<div class="table-responsive">
  <table class="sortable table table-striped table-hover table-sm order-table">
    <caption>Sessions for <holder id="txt-month-year-caption"></holder>.</caption>
    <thead>
      <tr>
        <th>#</th>
        <th></th>
        <th>Full Name</th>
        <th>ID</th>
        <th>Phone</th>
      </tr>
    </thead>
    <tbody id="allExistingUsers">
    </tbody>
  </table>
</div>
<hr class="mb-4">
<center class="align-center">
    <button type="button" class="btn btn-outline-primary">Add New Session</button>
    <button type="button" class="btn btn-outline-secondary">Bulk Add Session</button>
</center>
</main>

<script>
  console.log("Hello from "+window.location.pathname+window.location.search); 
  
  // Default Select for Month and Year
  document.getElementById("input-month").value = today.getMonth();
  document.getElementById("input-year").value = today.getFullYear();
  if (today.getMonth()===12) {
    document.getElementById("input-year").value = today.getFullYear()-1;
  }
  $("#txt-month-year-caption").html(monthNames[$("#input-month").val()]+" "+$("#input-year").val());
  $("#txt-month-year-table").html(monthNames[$("#input-month").val()]+" "+$("#input-year").val());

  // We listen for button click and query the relevant months
  $('#btn-show-session').on('click', function() {
      console.log("#input-month is "+$("#input-month").val());
      const queryMonthYear = monthNames[$("#input-month").val()]+$("#input-year").val();
      $("#txt-month-year-caption").html(monthNames[$("#input-month").val()]+" "+$("#input-year").val());
      $("#txt-month-year-table").html(monthNames[$("#input-month").val()]+" "+$("#input-year").val());
      //getSpecificMonthBonus(queryMonthYear);
  })

  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      console.log("user.providerData[0].phoneNumber.substring(1) is "+user.providerData[0].phoneNumber.substring(1));
      
      db.collection("users").where("phone","==",user.providerData[0].phoneNumber.substring(1))
      .get().then(function(userData) {
        userData.forEach(function(userSingle) {
          console.log("Current userSingle is: "+userSingle.data().organization);
          $('#txt-org-name').html(userSingle.data().organization);
          $('#txt-org-name-table').html(userSingle.data().organization);
          loadExistingUsers(userSingle.data().organization);
        })
      }).then(function() {
        console.log("Err.... Done?");
      }).catch(function(e) {
        console.log("Error fetching user details: ", e);
      });

    } else {
      console.log("User NOT signed in.");
    }
  });
  
  function loadExistingUsers(orgName) {
    console.log("orgName requested is: "+orgName);
    db.collection("users").where("organization","==",orgName)
    .get().then(function(allUsers) {

      var tableBody = document.getElementById('allExistingUsers');
      while (tableBody.firstChild) {
        tableBody.removeChild(tableBody.firstChild);
      }
      var i = 1;

      allUsers.forEach(function(eachUser) {
        console.log("Now processing: "+eachUser.data().name);

        var row = document.createElement('tr');
 
        var cellNum = document.createElement('td');
        cellNum.appendChild(document.createTextNode(i));
        
        var cellDummy = document.createElement('td');
        cellDummy.appendChild(document.createTextNode(i));
        
        var cellName = document.createElement('td');
        cellName.appendChild(document.createTextNode(eachUser.data().name));
        
        var cellId = document.createElement('td');
        cellId.appendChild(document.createTextNode(eachUser.data().unique_id));

        var cellPhone = document.createElement('td');
        cellPhone.appendChild(document.createTextNode(eachUser.data().phone));

        row.appendChild(cellNum);
        row.appendChild(cellDummy);
        row.appendChild(cellName);
        row.appendChild(cellId);
        row.appendChild(cellPhone);
        tableBody.appendChild(row);
        i=i+1;                    
      })

    }).catch(function(e) {
      console.log("Error fetching all existing user of "+orgName+" :", e);
    });
  }
  
</script>
