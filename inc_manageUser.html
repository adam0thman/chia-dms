<h2 class="text-info">Manage Users <small class="text-muted">For <holder id="txt-org-name"></holder></small> <button class="btn btn-outline-secondary" id="btn-show-users" disabled="disabled">Show Users</button></h2>

<hr class="mb-12">

<form class="form-inline">
  <div class="form-group mb-2">
    <label for="staticfilter" class="sr-only">Search </label>
    <input id="staticfilter"  type="search" class="form-control-plaintext light-table-filter" data-table="order-table" placeholder="Search keyword here..">
  </div>
</form>
<div class="table-responsive">
  <table class="sortable table table-striped table-hover table-sm order-table">
    <caption>Existing users for <holder id="txt-org-name-table"></holder></caption>
    <thead>
      <tr>
        <th>#</th>
        <th></th>
        <th>Full Name</th>
        <th>ID</th>
        <th>Phone</th>
      </tr>
    </thead>
    <tbody id="allExistingUsers">
    </tbody>
  </table>
</div>
<hr class="mb-4">
<center class="align-center">
    <button type="button" class="btn btn-outline-primary" id="btn-add-new" data-toggle="modal" data-target="#modal-add-user">Add New User</button>
    <button type="button" class="btn btn-outline-secondary">Bulk Add New User</button>
</center>


<!--
    MODAL: Add New User
-->
<div class="modal fade" id="modal-add-user" tabindex="-1" role="dialog" aria-labelledby="modal-add-user-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modal-add-user-label">Add New User</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="user-name" class="col-form-label">Full Name:</label>
              <input type="text" class="form-control" id="user-name" placeholder="Eg: Muhammad Bin Abdullah">
            </div>
            <div class="row">
              <div class="form-group col-sm-6">
                    <label for="user-mobile-country" class="col-form-label">Country Code:</label>
                    <select class="form-control">
                      <option value="60">Malaysia (+60)</option>
                    </select>
              </div>
              <div class="form-group col-sm-6">
                  <label for="user-mobile" class="col-form-label">Mobile Number:</label>
                  <input type="text" class="form-control" id="user-mobile" placeholder="Ex: 122557193">
            </div>
          </div> <!-- ./row-->
            <div class="form-group">
              <label for="user-id" class="col-form-label">Student ID:</label>
              <input type="text" class="form-control" id="user-ic" placeholder="Eg: UMC123456">
            </div>
          <div class="form-group">
              <hr class="mb-4" >
              <span class="text-muted">This user <text class="text-dark">Organization</text> will be set to <holder class="text-dark" id="txt-org-name-modal"></holder>.</span>
              <hr class="mb-4" >
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Add & Assign User</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    $('#modal-add-user').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget) // Button that triggered the modal
      var organization = button.data('organization') // Extract info from data-* attributes
      var modal = $(this)
      modal.find('.modal-title').text(organization+': Add & Assign New User')
      //modal.find('#session-org').val(organization)
    })
  </script>


<script>
  console.log("Hello from "+window.location.pathname+window.location.search); 
  
  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      console.log("user.providerData[0].phoneNumber.substring(1) is "+user.providerData[0].phoneNumber.substring(1));
      
      db.collection("users").where("phone","==",user.providerData[0].phoneNumber.substring(1))
      .get().then(function(userData) {
        userData.forEach(function(userSingle) {
          console.log("Current userSingle is: "+userSingle.data().organization);
          $('#txt-name-top').html(userSingle.data().name);
          $('#txt-org-name').html(userSingle.data().organization);
          $('#txt-org-name-table').html(userSingle.data().organization);
          $('#btn-add-new').attr("data-organization",userSingle.data().organization);
          $('#txt-org-name-modal').html(userSingle.data().organization);
          $('#btn-show-users').attr("onClick", 'loadExistingUsers("'+userSingle.data().organization+'")');
          //loadExistingUsers(userSingle.data().organization);
        })
      }).then(function() {
        console.log("Err.... Done?");
        $('#btn-show-users').removeAttr('disabled');
      }).catch(function(e) {
        console.log("Error fetching user details: ", e);
      });

    } else {
      console.log("User NOT signed in.");
    }
  });
  
  function loadExistingUsers(orgName) {
    console.log("orgName requested is: "+orgName);
    db.collection("users").where("organization","==",orgName)
    .get().then(function(allUsers) {

      var tableBody = document.getElementById('allExistingUsers');
      while (tableBody.firstChild) {
        tableBody.removeChild(tableBody.firstChild);
      }
      var i = 1;

      allUsers.forEach(function(eachUser) {
        console.log("Now processing: "+eachUser.data().name);

        var row = document.createElement('tr');
 
        var cellNum = document.createElement('td');
        cellNum.appendChild(document.createTextNode(i));
        
        var cellDelete = document.createElement('td');
        cellDelete.innerHTML = '<button class="btn btn-small" '+
                               'onClick="deleteUser("'+orgName+'","'+eachUser.data().unique_id.trim()+'")">'+
                               '<i class="far fa-trash-alt text-danger"></i>'+
                               '</button>';
        //cellDelete.innerHTML = '<button class="btn btn-small" onClick="adam()"><i class="far fa-trash-alt text-danger"></i></button>';
        

        var cellName = document.createElement('td');
        cellName.appendChild(document.createTextNode(eachUser.data().name));
        
        var cellId = document.createElement('td');
        cellId.appendChild(document.createTextNode(eachUser.data().unique_id));

        var cellPhone = document.createElement('td');
        cellPhone.appendChild(document.createTextNode(eachUser.data().phone));

        row.appendChild(cellNum);
        row.appendChild(cellDelete);
        row.appendChild(cellName);
        row.appendChild(cellId);
        row.appendChild(cellPhone);
        tableBody.appendChild(row);
        i=i+1;                    
      })

    }).then(function() {
      $('#btn-show-users').hide();
    }).catch(function(e) {
      console.log("Error fetching all existing user of "+orgName+" :", e);
    });
  }
  
function deleteUser(userId, orgName) {
  document.preventDefault()
  db.collection("users/").doc(userId).delete().then(function() {
    console.log("Deleted user "+userId);
    loadExistingUsers(orgName);
  }).catch(function(e) {
    console.log("Error deleting user "+userId+": ",e);
  });
}

function adam() {
  console.log("Adam clicked!");
}

</script>